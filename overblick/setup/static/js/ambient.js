/**
 * Ambient Music — Tico Tico (Zequinha de Abreu)
 *
 * MIDI-sourced arrangement played through warm Web Audio synths:
 * vibraphone melody, soft pad chords, gentle sine bass.
 * 128-beat loop at 96 BPM (~80 seconds).
 */

(function () {
    'use strict';

    var STORAGE_KEY = 'overblick_setup_volume';
    var BPM = 96;
    var BEAT_SEC = 60 / BPM;
    var LOOP_BEATS = 128;
    var LOOP_SEC = LOOP_BEATS * BEAT_SEC;
    var SCHEDULE_AHEAD = 0.3; // seconds to schedule ahead

    var audioCtx = null;
    var masterGain = null;
    var isPlaying = false;
    var schedulerTimer = null;
    var loopStartTime = 0;
    var melIdx = 0, chdIdx = 0, basIdx = 0;
    var scheduledUpToBeat = 0;

    function midi2freq(m) { return 440 * Math.pow(2, (m - 69) / 12); }

    // ── Note data from MIDI (Tico Tico — Zequinha de Abreu) ─────────
    // Format: flat array [beat, midi, duration_beats, velocity, ...]
    // Melody: 352 notes — right hand, bright vibraphone
    // Chords: 228 notes — sustained pads only (arpeggios stripped)
    // Bass:   198 notes — walking bass line

    /* eslint-disable */
    var MEL=[8.0,70,1.5,0.8,9.5,65,0.5,0.59,9.75,66,0.125,0.59,9.88,68,0.125,0.59,10.0,66,0.5,0.59,10.5,65,0.5,0.59,11.0,65,0.5,0.59,11.5,65,0.5,0.59,11.75,73,0.125,0.59,11.88,75,0.125,0.59,12.0,73,0.5,0.8,12.5,65,0.5,0.59,13.0,65,0.5,0.59,13.5,65,0.5,0.59,13.75,66,0.125,0.59,13.88,68,0.125,0.59,14.0,66,0.5,0.59,14.5,65,0.5,0.59,15.0,65,0.5,0.59,15.5,65,0.5,0.59,16.0,72,0.05,0.59,16.0,68,0.05,0.59,16.5,80,0.5,0.69,17.0,79,0.5,0.69,17.5,77,0.5,0.59,18.0,76,0.5,0.49,18.5,77,0.5,0.49,19.0,75,0.5,0.49,19.5,73,0.5,0.49,20.0,72,0.5,0.49,20.5,73,0.5,0.49,21.0,72,0.5,0.49,21.5,70,0.5,0.49,22.0,68,0.5,0.49,22.5,67,0.5,0.49,23.0,65,1.0,0.49,24.0,70,1.5,0.8,25.5,65,0.5,0.59,25.75,66,0.125,0.59,25.88,68,0.125,0.59,26.0,66,0.5,0.59,26.5,65,0.5,0.59,27.0,65,0.5,0.59,27.5,65,0.5,0.59,27.75,73,0.125,0.59,27.88,75,0.125,0.59,28.0,73,0.5,0.8,28.5,65,0.5,0.59,29.0,65,0.5,0.59,29.5,65,0.5,0.59,29.75,66,0.125,0.59,29.88,68,0.125,0.59,30.0,66,0.5,0.59,30.5,65,0.5,0.59,31.0,65,0.5,0.59,31.5,65,0.5,0.59,32.0,72,0.05,0.59,32.0,68,0.05,0.59,32.5,80,0.5,0.69,33.0,79,0.5,0.69,33.5,77,0.5,0.59,34.0,76,0.5,0.49,34.5,77,0.5,0.49,35.0,75,0.5,0.49,35.5,73,0.5,0.49,36.0,72,0.5,0.49,36.5,73,0.5,0.49,37.0,72,0.5,0.49,37.5,70,0.5,0.49,38.0,68,0.5,0.49,38.5,67,0.5,0.49,39.0,65,1.0,0.49,40.0,72,1.5,0.59,41.5,65,0.5,0.59,41.75,66,0.125,0.59,41.88,68,0.125,0.59,42.0,66,0.5,0.9,42.5,65,0.5,0.9,43.0,65,0.5,0.9,43.75,76,0.125,0.9,43.88,77,0.125,0.9,44.0,76,0.5,0.9,44.5,77,0.5,0.9,45.0,77,0.5,0.9,45.5,77,0.5,0.9,46.0,75,1.0,0.9,46.0,80,1.25,0.9,47.25,78,0.25,0.59,47.5,75,0.25,0.59,47.75,76,0.25,0.59,48.0,77,0.25,0.8,48.25,73,0.25,0.59,48.5,67,0.25,0.59,48.75,68,0.25,0.59,49.0,67,0.25,0.59,49.25,68,0.25,0.59,49.5,67,0.25,0.59,49.75,68,0.25,0.59,50.0,78,0.25,0.8,50.25,75,0.25,0.59,50.5,68,0.25,0.59,50.75,69,0.25,0.59,51.0,68,0.25,0.59,51.25,69,0.25,0.59,51.5,68,0.25,0.59,51.75,69,0.25,0.59,52.0,77,0.25,0.8,52.25,73,0.25,0.59,52.5,67,0.25,0.59,52.75,68,0.25,0.59,53.0,67,0.25,0.59,53.25,68,0.25,0.59,53.5,67,0.25,0.59,53.75,68,0.25,0.59,54.0,78,0.25,0.59,54.25,75,0.25,0.59,54.5,68,0.25,0.59,54.75,69,0.25,0.59,55.0,68,0.25,0.59,55.25,69,0.25,0.59,55.5,68,0.25,0.59,55.75,69,0.25,0.59,56.0,77,0.25,0.59,56.25,73,0.25,0.59,56.5,67,0.25,0.59,56.75,68,0.25,0.59,57.0,80,0.25,0.69,57.25,77,0.25,0.69,57.5,70,0.25,0.69,57.75,71,0.25,0.69,58.0,79,0.25,0.69,58.25,75,0.25,0.69,58.5,69,0.25,0.69,58.75,70,0.25,0.69,59.0,78,0.25,0.59,59.25,75,0.25,0.59,59.5,68,0.25,0.59,59.75,69,0.25,0.59,60.0,77,0.25,0.59,60.25,73,0.25,0.59,60.5,67,0.25,0.59,60.75,68,0.25,0.59,61.0,80,0.25,0.69,61.25,77,0.25,0.69,61.5,70,0.25,0.69,61.75,71,0.25,0.69,62.0,79,0.25,0.69,62.25,75,0.25,0.69,62.5,69,0.25,0.69,62.75,70,0.25,0.69,63.0,78,0.25,0.59,63.25,75,0.25,0.59,63.5,68,0.25,0.59,63.75,69,0.25,0.59,64.0,77,0.5,0.59,64.0,73,0.5,0.59,64.5,79,0.25,0.59,64.75,77,0.25,0.59,65.0,80,0.25,0.69,65.25,77,0.25,0.69,65.5,81,0.25,0.69,65.75,77,0.25,0.69,66.0,82,0.25,0.69,66.25,77,0.25,0.69,66.5,81,0.25,0.69,66.75,77,0.25,0.69,67.0,82,0.25,0.8,67.25,77,0.25,0.8,67.5,83,0.25,0.8,67.75,77,0.25,0.8,68.0,84,1.5,0.9,68.0,79,1.5,0.9,68.0,76,1.5,0.9,69.5,72,0.5,0.9,69.75,73,0.125,0.9,69.88,75,0.125,0.9,70.0,73,0.5,0.9,70.5,72,0.5,0.9,71.0,72,0.5,0.9,71.75,71,0.125,0.9,71.88,72,0.125,0.9,72.0,71,0.5,0.9,72.5,72,0.5,0.9,73.0,72,0.5,0.9,73.5,72,0.5,0.9,74.0,72,1.0,0.9,74.0,77,1.25,0.9,75.25,75,0.25,0.59,75.5,71,0.25,0.59,75.75,72,0.25,0.59,76.0,73,1.5,0.49,76.0,70,1.5,0.49,77.5,65,0.5,0.49,77.75,66,0.125,0.49,77.88,68,0.125,0.49,78.0,66,0.5,0.49,78.5,65,0.5,0.49,79.0,65,0.5,0.49,79.5,65,0.5,0.49,79.75,73,0.125,0.49,79.88,75,0.125,0.49,80.0,73,0.5,0.69,80.5,65,0.5,0.49,81.0,65,0.5,0.49,81.5,65,0.5,0.49,81.75,66,0.125,0.49,81.88,68,0.125,0.49,82.0,66,0.5,0.49,82.5,65,0.5,0.49,83.0,65,0.5,0.49,83.5,65,0.5,0.49,84.0,72,0.05,0.59,84.0,68,0.05,0.59,84.5,80,0.5,0.69,85.0,79,0.5,0.69,85.5,77,0.5,0.59,86.0,76,0.5,0.49,86.5,77,0.5,0.49,87.0,75,0.5,0.49,87.5,73,0.5,0.49,88.0,72,0.5,0.49,88.5,73,0.5,0.49,89.0,72,0.5,0.49,89.5,70,0.5,0.49,90.0,68,0.5,0.49,90.5,67,0.5,0.49,91.0,65,1.0,0.49,92.0,72,1.5,0.59,93.5,65,0.5,0.59,93.75,66,0.125,0.59,93.88,68,0.125,0.59,94.0,66,0.5,0.9,94.5,65,0.5,0.9,95.0,65,0.5,0.9,95.75,76,0.125,0.9,95.88,77,0.125,0.9,96.0,76,0.5,0.9,96.5,77,0.5,0.9,97.0,77,0.5,0.9,97.5,77,0.5,0.9,98.0,77,1.0,0.9,98.0,82,1.25,0.9,99.25,80,0.25,0.59,99.5,76,0.25,0.59,99.75,77,0.25,0.59,100.0,78,0.25,0.8,100.25,75,0.25,0.59,100.5,69,0.25,0.59,100.75,70,0.25,0.59,101.0,69,0.25,0.59,101.25,70,0.25,0.59,101.5,69,0.25,0.59,101.75,70,0.25,0.59,102.0,80,0.25,0.8,102.25,77,0.25,0.59,102.5,69,0.25,0.59,102.75,70,0.25,0.59,103.0,69,0.25,0.59,103.25,70,0.25,0.59,103.5,69,0.25,0.59,103.75,70,0.25,0.59,104.0,78,0.25,0.8,104.25,75,0.25,0.59,104.5,69,0.25,0.59,104.75,70,0.25,0.59,105.0,69,0.25,0.59,105.25,70,0.25,0.59,105.5,69,0.25,0.59,105.75,70,0.25,0.59,106.0,80,0.25,0.8,106.25,77,0.25,0.59,106.5,69,0.25,0.59,106.75,70,0.25,0.59,107.0,69,0.25,0.59,107.25,70,0.25,0.59,107.5,69,0.25,0.59,107.75,70,0.25,0.59,108.0,78,0.5,0.59,108.0,75,0.5,0.59,108.5,77,0.25,0.9,108.5,73,0.25,0.9,108.75,70,0.25,0.9,109.0,75,0.25,0.9,109.25,70,0.25,0.9,109.5,77,0.25,0.9,109.5,73,0.25,0.9,109.75,70,0.25,0.9,110.0,75,0.25,0.9,110.25,70,0.25,0.9,110.5,73,0.25,0.9,110.75,70,0.25,0.9,111.0,72,0.25,0.9,111.0,69,0.25,0.9,111.25,65,0.25,0.9,111.5,70,0.25,0.9,111.75,65,0.25,0.9,112.0,72,0.25,0.9,112.25,66,0.25,0.9,112.5,73,0.25,0.9,112.75,66,0.25,0.9,113.0,75,0.25,0.9,113.25,70,0.25,0.9,113.5,77,0.25,0.9,113.75,69,0.25,0.9,114.0,75,0.25,0.9,114.25,70,0.25,0.9,114.5,73,0.25,0.9,114.75,70,0.25,0.9,115.0,78,0.25,0.9,115.0,75,0.25,0.9,115.25,70,0.25,0.9,115.5,77,0.25,0.9,115.75,70,0.25,0.9,116.0,78,0.25,0.9,116.0,75,0.25,0.9,116.25,70,0.25,0.9,116.5,77,0.25,0.9,116.75,70,0.25,0.9,117.0,75,0.25,0.9,117.25,70,0.25,0.9,117.5,77,0.25,0.9,117.5,73,0.25,0.9,117.75,70,0.25,0.9,118.0,75,0.25,0.9,118.25,70,0.25,0.9,118.5,73,0.25,0.9,118.75,70,0.25,0.9,119.0,72,0.25,0.9,119.0,69,0.25,0.9,119.25,66,0.25,0.9,119.5,70,0.25,0.9,119.75,65,0.25,0.9,120.0,72,0.25,0.9,120.25,66,0.25,0.9,120.5,73,0.25,0.9,120.75,70,0.25,0.9,121.0,75,0.25,0.9,121.25,70,0.25,0.9,121.5,77,0.25,0.9,121.75,69,0.25,0.9,122.0,70,1.0,0.9,124.0,89,1.5,0.9,124.0,84,1.5,0.9,124.0,81,1.5,0.9,125.5,77,0.5,0.9,125.75,82,0.125,0.9,125.88,84,0.125,0.9,126.0,82,0.5,0.9,126.0,78,0.5,0.9,126.5,77,0.5,0.9,127.0,77,0.5,0.9,127.5,77,0.5,0.9];
    var CHD=[22.5,64,0.5,0.39,22.5,60,0.5,0.39,22.5,58,0.5,0.39,23.0,65,1.0,0.39,23.0,60,1.0,0.39,23.0,57,1.0,0.39,38.5,64,0.5,0.39,38.5,60,0.5,0.39,38.5,58,0.5,0.39,39.0,65,1.0,0.39,39.0,60,1.0,0.39,39.0,57,1.0,0.39,43.5,72,0.5,0.69,43.5,69,0.5,0.69,43.5,65,0.5,0.69,44.0,72,0.5,0.69,44.0,70,0.5,0.69,44.0,64,0.5,0.69,44.5,72,0.5,0.69,44.5,69,0.5,0.69,44.5,65,0.5,0.69,45.0,72,0.5,0.69,45.0,69,0.5,0.69,45.0,65,0.5,0.69,45.5,72,0.5,0.69,45.5,69,0.5,0.69,45.5,65,0.5,0.69,46.0,72,2.0,0.69,46.0,68,2.0,0.69,46.0,66,2.0,0.69,46.0,63,2.0,0.69,46.0,56,2.0,0.69,48.0,65,2.0,0.69,48.0,56,2.0,0.69,50.0,66,1.5,0.8,51.5,57,0.5,0.8,52.0,56,1.5,0.8,53.5,65,0.5,0.8,54.0,66,1.5,0.8,55.5,57,0.5,0.8,56.0,56,0.5,0.8,56.5,58,0.5,0.8,57.0,59,1.5,0.8,58.5,58,1.0,0.8,59.5,63,0.5,0.8,59.5,57,0.5,0.8,59.5,54,0.5,0.8,60.0,56,0.5,0.8,60.0,53,0.5,0.8,60.5,58,0.5,0.8,61.0,59,1.5,0.8,62.5,58,1.0,0.8,63.5,63,0.5,0.8,63.5,57,0.5,0.8,63.5,54,0.5,0.8,64.0,68,0.5,0.49,64.0,56,0.5,0.8,64.0,53,0.5,0.8,64.5,67,0.5,0.49,64.5,53,1.0,0.8,65.0,68,0.5,0.59,65.5,69,0.5,0.59,65.5,53,1.0,0.8,66.0,70,0.5,0.59,66.5,69,0.5,0.59,66.5,53,0.5,0.8,67.0,70,0.5,0.59,67.0,53,0.5,0.8,67.5,71,0.5,0.59,67.5,53,0.5,0.8,68.0,72,1.5,0.59,68.0,67,1.5,0.59,68.0,64,1.5,0.59,68.0,55,1.0,0.8,68.0,52,1.0,0.8,69.5,67,0.5,0.59,69.5,64,0.5,0.59,70.0,68,0.5,0.59,70.0,65,0.5,0.59,70.0,60,1.5,0.8,70.5,67,0.5,0.59,70.5,64,0.5,0.59,71.0,67,0.5,0.59,71.0,64,0.5,0.59,71.5,67,0.5,0.59,71.5,64,0.5,0.59,71.5,48,0.5,0.8,72.0,65,0.5,0.59,72.0,59,0.5,0.59,72.0,49,0.5,0.8,72.5,64,0.5,0.59,72.5,60,0.5,0.59,72.5,48,0.5,0.8,73.0,64,0.5,0.59,73.0,60,0.5,0.59,73.0,48,0.5,0.8,73.5,64,0.5,0.59,73.5,60,0.5,0.59,73.5,48,0.5,0.8,74.0,69,2.0,0.59,74.0,65,2.0,0.59,74.0,60,2.0,0.59,74.0,53,1.5,0.8,75.5,41,0.5,0.8,90.5,64,0.5,0.39,90.5,60,0.5,0.39,90.5,58,0.5,0.39,91.0,65,1.0,0.39,91.0,60,1.0,0.39,91.0,57,1.0,0.39,95.5,72,0.5,0.69,95.5,69,0.5,0.69,95.5,65,0.5,0.69,96.0,72,0.5,0.69,96.0,70,0.5,0.69,96.0,64,0.5,0.69,96.5,72,0.5,0.69,96.5,69,0.5,0.69,96.5,65,0.5,0.69,97.0,72,0.5,0.69,97.0,54,0.5,0.69,97.0,65,0.5,0.69,97.0,69,0.5,0.69,97.5,72,0.5,0.69,97.5,69,0.5,0.69,97.5,65,0.5,0.69,98.0,74,2.0,0.69,98.0,70,2.0,0.69,98.0,68,2.0,0.69,98.0,62,2.0,0.69,98.0,58,2.0,0.69,100.0,63,2.0,0.69,100.0,58,2.0,0.69,102.0,68,1.5,0.8,103.5,58,0.5,0.8,104.0,66,2.0,0.8,104.0,63,2.0,0.8,106.0,68,1.5,0.8,107.5,58,0.5,0.8,108.0,66,0.5,0.69,108.0,63,0.5,0.69,108.5,65,0.5,0.8,108.5,58,0.5,0.69,109.0,63,0.5,0.8,109.0,58,0.5,0.69,109.5,65,0.5,0.8,109.5,58,0.5,0.69,110.0,63,0.5,0.8,110.0,58,0.5,0.69,110.5,61,0.5,0.8,110.5,58,0.5,0.69,111.0,60,0.5,0.8,111.0,57,0.5,0.69,111.0,53,0.5,0.69,111.5,61,0.5,0.8,111.5,58,0.5,0.69,111.5,53,0.5,0.69,112.0,60,0.5,0.8,112.0,58,0.5,0.69,112.0,51,0.5,0.69,112.5,61,0.5,0.8,112.5,58,0.5,0.69,112.5,48,0.5,0.69,113.0,63,0.5,0.8,113.0,60,0.5,0.69,113.0,53,0.5,0.69,113.5,65,0.5,0.8,113.5,60,0.5,0.69,113.5,57,0.5,0.69,113.5,53,0.5,0.69,114.0,63,0.5,0.8,114.0,60,0.5,0.69,114.0,53,0.5,0.69,114.5,61,0.5,0.8,114.5,58,0.5,0.69,114.5,53,0.5,0.69,115.0,66,0.5,0.8,115.0,63,0.5,0.8,115.0,58,0.5,0.69,115.0,51,0.5,0.69,115.5,65,0.5,0.8,115.5,61,0.5,0.8,115.5,46,0.5,0.69,116.0,66,0.5,0.8,116.0,63,0.5,0.8,116.0,58,0.5,0.69,116.0,51,0.5,0.69,116.5,65,0.5,0.8,116.5,61,0.5,0.8,116.5,46,0.5,0.69,117.0,63,0.5,0.8,117.0,58,0.5,0.69,117.5,65,0.5,0.8,117.5,58,0.5,0.69,118.0,63,0.5,0.8,118.0,58,0.5,0.69,118.5,61,0.5,0.8,118.5,58,0.5,0.69,119.0,60,0.5,0.8,119.0,57,0.5,0.69,119.5,61,0.5,0.8,119.5,58,0.5,0.69,119.5,53,0.5,0.69,120.0,60,0.5,0.8,120.0,58,0.5,0.69,120.0,51,0.5,0.69,120.5,61,0.5,0.8,120.5,58,0.5,0.69,120.5,48,0.5,0.69,121.0,65,0.5,0.8,121.0,63,0.5,0.8,121.0,60,0.5,0.69,121.0,53,0.5,0.69,121.5,65,0.5,0.8,121.5,63,0.5,0.8,121.5,60,0.5,0.69,121.5,53,0.5,0.69,122.0,70,1.5,0.8,122.0,65,1.5,0.8,122.0,61,1.5,0.8,123.5,65,0.5,0.8,124.0,77,1.5,0.8,124.0,72,1.5,0.8,124.0,69,1.5,0.8,125.5,65,0.5,0.8,126.0,73,1.5,0.8,126.0,70,1.5,0.8,127.5,65,0.5,0.8];
    var BAS=[0.0,46,0.5,0.39,0.0,34,0.5,0.39,1.5,46,0.5,0.39,2.0,34,0.5,0.39,3.5,46,0.5,0.39,4.0,34,0.5,0.39,5.5,46,0.5,0.39,6.0,34,0.5,0.39,7.5,46,0.5,0.39,8.0,34,1.5,0.39,9.5,34,0.5,0.39,10.0,39,0.5,0.39,10.5,34,0.5,0.39,11.0,34,0.5,0.39,11.5,34,0.5,0.39,12.0,46,0.5,0.59,12.5,34,0.5,0.39,13.0,34,0.5,0.39,13.5,34,0.5,0.39,14.0,39,0.5,0.39,14.5,34,0.5,0.39,15.0,34,0.5,0.39,15.5,34,0.5,0.39,16.0,36,0.5,0.39,17.5,48,0.5,0.39,18.0,37,0.5,0.39,19.5,49,0.5,0.39,20.0,34,0.5,0.39,21.5,46,0.5,0.39,22.0,36,0.05,0.39,22.5,48,0.05,0.39,23.0,41,1.0,0.39,24.0,34,1.5,0.39,25.5,34,0.5,0.39,26.0,39,0.5,0.39,26.5,34,0.5,0.39,27.0,34,0.5,0.39,27.5,34,0.5,0.39,28.0,46,0.5,0.59,28.5,34,0.5,0.39,29.0,34,0.5,0.39,29.5,34,0.5,0.39,30.0,39,0.5,0.39,30.5,34,0.5,0.39,31.0,34,0.5,0.39,31.5,34,0.5,0.39,32.0,36,0.5,0.39,33.5,48,0.5,0.39,34.0,37,0.5,0.39,35.5,49,0.5,0.39,36.0,34,0.5,0.39,37.5,46,0.5,0.39,38.0,36,0.05,0.39,38.5,48,0.05,0.39,39.0,41,1.0,0.39,40.0,41,1.5,0.49,40.0,29,1.5,0.49,41.5,41,0.5,0.59,41.5,29,0.5,0.59,42.0,41,1.5,0.59,42.0,29,1.5,0.59,43.5,41,0.5,0.69,43.75,42,0.125,0.69,43.88,44,0.125,0.69,44.0,42,0.5,0.69,44.5,41,0.5,0.69,45.0,41,0.5,0.69,45.5,41,0.5,0.69,46.0,44,2.0,0.69,46.0,32,2.0,0.69,48.0,49,2.0,0.69,48.0,37,2.0,0.69,50.0,48,2.0,0.69,50.0,36,2.0,0.69,52.0,49,2.0,0.69,52.0,37,2.0,0.69,54.0,48,2.0,0.69,54.0,36,2.0,0.69,56.0,49,1.5,0.69,56.0,37,1.5,0.69,57.5,50,0.5,0.69,57.5,38,0.5,0.69,58.0,51,0.5,0.69,58.0,39,0.5,0.69,59.0,48,0.5,0.69,59.0,36,0.5,0.69,60.0,49,1.5,0.69,60.0,37,1.5,0.69,61.5,50,0.5,0.69,61.5,38,0.5,0.69,62.0,51,0.5,0.69,62.0,39,0.5,0.69,63.0,48,0.5,0.69,63.0,36,0.5,0.69,64.0,49,0.5,0.69,64.0,37,0.5,0.69,64.5,49,1.0,0.69,64.5,37,1.0,0.69,65.5,49,1.0,0.69,65.5,37,1.0,0.69,66.5,49,0.5,0.69,66.5,37,0.5,0.69,67.0,49,0.5,0.69,67.0,37,0.5,0.69,67.5,49,0.5,0.69,67.5,37,0.5,0.69,68.0,48,1.0,0.69,68.0,36,1.0,0.69,70.0,48,1.5,0.69,71.5,36,0.5,0.69,71.75,37,0.125,0.69,71.88,39,0.125,0.69,72.0,37,0.5,0.69,72.5,36,0.5,0.69,73.0,36,0.5,0.69,73.5,36,0.5,0.69,74.0,41,1.5,0.69,75.5,29,0.5,0.69,76.0,34,1.5,0.39,77.5,34,0.5,0.39,78.0,39,0.5,0.39,78.5,34,0.5,0.39,79.0,34,0.5,0.39,79.5,34,0.5,0.39,80.0,46,0.5,0.59,80.5,34,0.5,0.39,81.0,34,0.5,0.39,81.5,34,0.5,0.39,82.0,39,0.5,0.39,82.5,34,0.5,0.39,83.0,34,0.5,0.39,83.5,34,0.5,0.39,84.0,36,0.5,0.39,85.5,48,0.5,0.39,86.0,37,0.5,0.39,87.5,49,0.5,0.39,88.0,34,0.5,0.39,89.5,46,0.5,0.39,90.0,36,0.05,0.39,90.5,48,0.05,0.39,91.0,41,1.0,0.39,92.0,41,1.5,0.49,92.0,29,1.5,0.49,93.5,41,0.5,0.49,93.5,29,0.5,0.49,94.0,41,1.5,0.49,94.0,29,1.5,0.49,95.5,41,0.5,0.69,95.75,42,0.125,0.69,95.88,44,0.125,0.69,96.0,42,0.5,0.69,96.5,41,0.5,0.69,97.0,41,0.5,0.69,97.5,41,0.5,0.69,98.0,46,2.0,0.69,98.0,34,2.0,0.69,100.0,51,2.0,0.69,100.0,39,2.0,0.69,102.0,50,2.0,0.69,102.0,38,2.0,0.69,104.0,51,2.0,0.69,104.0,39,2.0,0.69,106.0,50,2.0,0.69,106.0,38,2.0,0.69,108.0,51,0.5,0.69,108.0,39,0.5,0.69,108.5,41,0.5,0.69,109.0,42,0.5,0.69,109.5,41,0.5,0.69,110.0,42,0.5,0.69,110.5,41,0.5,0.69,111.0,39,0.5,0.69,111.5,37,0.5,0.69,112.0,39,0.5,0.69,112.5,36,0.5,0.69,113.0,41,0.5,0.69,113.5,29,0.5,0.69,114.0,34,1.0,0.69,115.0,39,0.5,0.69,115.5,34,0.5,0.69,116.0,39,0.5,0.69,116.5,34,0.5,0.69,117.0,42,0.5,0.69,117.5,41,0.5,0.69,118.0,42,0.5,0.69,118.5,41,0.5,0.69,119.0,39,0.5,0.69,119.5,37,0.5,0.69,120.0,39,0.5,0.69,120.5,36,0.5,0.69,121.0,41,0.5,0.69,121.5,29,0.5,0.69,122.0,34,1.5,0.69,123.5,34,0.5,0.69,124.0,34,1.5,0.69,125.5,34,0.5,0.69,126.0,34,1.5,0.69,127.5,34,0.5,0.69];
    /* eslint-enable */

    // ── Synth engine ─────────────────────────────────────────────────
    // Pure sine waves with musical envelopes. No harsh harmonics.

    function playMelody(midi, time, dur, vel) {
        if (!audioCtx || midi === 0) return;
        var freq = midi2freq(midi);
        var durSec = dur * BEAT_SEC;
        var vol = vel * 0.06;

        // Vibraphone: sine + gentle 2nd partial, fast attack, natural decay
        var env = audioCtx.createGain();
        env.gain.setValueAtTime(0, time);
        env.gain.linearRampToValueAtTime(vol, time + 0.005);
        env.gain.exponentialRampToValueAtTime(vol * 0.5, time + Math.min(durSec, 0.15));
        env.gain.exponentialRampToValueAtTime(0.001, time + durSec + 0.1);

        var osc1 = audioCtx.createOscillator();
        osc1.type = 'sine';
        osc1.frequency.value = freq;
        osc1.connect(env);
        osc1.start(time);
        osc1.stop(time + durSec + 0.15);

        // Soft 2nd harmonic for brightness
        var g2 = audioCtx.createGain();
        g2.gain.value = 0.25;
        var osc2 = audioCtx.createOscillator();
        osc2.type = 'sine';
        osc2.frequency.value = freq * 2;
        osc2.connect(g2);
        g2.connect(env);
        osc2.start(time);
        osc2.stop(time + durSec + 0.15);

        env.connect(masterGain);
    }

    function playChord(midi, time, dur, vel) {
        if (!audioCtx || midi === 0) return;
        var freq = midi2freq(midi);
        var durSec = dur * BEAT_SEC;
        var vol = vel * 0.02; // Very soft pads

        var env = audioCtx.createGain();
        env.gain.setValueAtTime(0, time);
        env.gain.linearRampToValueAtTime(vol, time + 0.05);
        env.gain.setValueAtTime(vol, time + Math.max(0, durSec - 0.08));
        env.gain.linearRampToValueAtTime(0, time + durSec);

        var osc = audioCtx.createOscillator();
        osc.type = 'sine';
        osc.frequency.value = freq;
        osc.connect(env);
        osc.start(time);
        osc.stop(time + durSec + 0.05);

        env.connect(masterGain);
    }

    function playBass(midi, time, dur, vel) {
        if (!audioCtx || midi === 0) return;
        var freq = midi2freq(midi);
        var durSec = dur * BEAT_SEC;
        var vol = vel * 0.08;

        var env = audioCtx.createGain();
        env.gain.setValueAtTime(0, time);
        env.gain.linearRampToValueAtTime(vol, time + 0.02);
        env.gain.exponentialRampToValueAtTime(vol * 0.6, time + 0.08);
        env.gain.exponentialRampToValueAtTime(0.001, time + durSec + 0.05);

        // Lowpass filter for warmth
        var filt = audioCtx.createBiquadFilter();
        filt.type = 'lowpass';
        filt.frequency.value = 500;
        filt.connect(env);

        var osc = audioCtx.createOscillator();
        osc.type = 'sine';
        osc.frequency.value = freq;
        osc.connect(filt);
        osc.start(time);
        osc.stop(time + durSec + 0.1);

        env.connect(masterGain);
    }

    // ── Note scheduler ───────────────────────────────────────────────

    function scheduleTrack(arr, idxRef, synthFn, fromBeat, toBeat, baseTime) {
        var idx = idxRef.v;
        while (idx < arr.length) {
            var beat = arr[idx];
            if (beat >= toBeat) break;
            if (beat >= fromBeat) {
                var midi = arr[idx + 1];
                var dur  = arr[idx + 2];
                var vel  = arr[idx + 3];
                var noteTime = baseTime + (beat - fromBeat) * BEAT_SEC;
                synthFn(midi, noteTime, dur, vel);
            }
            idx += 4;
        }
        idxRef.v = idx;
    }

    var melRef = {v: 0}, chdRef = {v: 0}, basRef = {v: 0};

    function scheduler() {
        if (!isPlaying || !audioCtx) return;

        var now = audioCtx.currentTime;
        var elapsed = now - loopStartTime;
        var currentBeat = elapsed / BEAT_SEC;

        // Handle looping
        while (currentBeat >= LOOP_BEATS) {
            loopStartTime += LOOP_SEC;
            currentBeat -= LOOP_BEATS;
            melRef.v = 0;
            chdRef.v = 0;
            basRef.v = 0;
        }

        var aheadBeat = currentBeat + (SCHEDULE_AHEAD / BEAT_SEC);
        var baseTime = loopStartTime + (currentBeat * BEAT_SEC);

        // Schedule each track up to the lookahead point
        scheduleTrack(MEL, melRef, playMelody, currentBeat, aheadBeat, loopStartTime);
        scheduleTrack(CHD, chdRef, playChord,  currentBeat, aheadBeat, loopStartTime);
        scheduleTrack(BAS, basRef, playBass,   currentBeat, aheadBeat, loopStartTime);
    }

    // ── Controls ─────────────────────────────────────────────────────

    function createAudioContext() {
        var AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();

        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0;

        // Gentle reverb via delay lines
        var revMix = audioCtx.createGain();
        revMix.gain.value = 0.2;
        var revFilter = audioCtx.createBiquadFilter();
        revFilter.type = 'lowpass';
        revFilter.frequency.value = 3000;

        [0.11, 0.17, 0.23, 0.31].forEach(function (dt, i) {
            var d = audioCtx.createDelay(1.0);
            d.delayTime.value = dt;
            var fb = audioCtx.createGain();
            fb.gain.value = [0.25, 0.20, 0.15, 0.10][i];
            masterGain.connect(d);
            d.connect(fb);
            fb.connect(d);
            fb.connect(revFilter);
        });

        revFilter.connect(revMix);
        revMix.connect(audioCtx.destination);
        masterGain.connect(audioCtx.destination);
    }

    function startMusic() {
        // Always create a fresh AudioContext — guarantees clean state
        if (audioCtx) {
            try { audioCtx.close(); } catch (e) { /* ok */ }
        }
        createAudioContext();

        var vol = parseFloat(localStorage.getItem(STORAGE_KEY) || '0.3');
        masterGain.gain.setValueAtTime(0, audioCtx.currentTime);
        masterGain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.5);

        isPlaying = true;
        loopStartTime = audioCtx.currentTime;
        melRef.v = 0;
        chdRef.v = 0;
        basRef.v = 0;

        var btn = document.getElementById('music-toggle');
        if (btn) btn.style.animation = '';

        updateButton();
        scheduler();
        schedulerTimer = setInterval(scheduler, 50);
    }

    function stopMusic() {
        isPlaying = false;
        if (schedulerTimer) {
            clearInterval(schedulerTimer);
            schedulerTimer = null;
        }
        // Close the entire AudioContext — kills all scheduled audio instantly
        if (audioCtx) {
            try { audioCtx.close(); } catch (e) { /* ok */ }
            audioCtx = null;
            masterGain = null;
        }
        updateButton();
    }

    function togglePlay() {
        if (isPlaying) { stopMusic(); } else { startMusic(); }
    }

    function updateButton() {
        var btn = document.getElementById('music-toggle');
        if (btn) {
            btn.classList.toggle('playing', isPlaying);
            btn.setAttribute('aria-label', isPlaying ? 'Stop music' : 'Play music');
            btn.textContent = isPlaying ? '\u23F9' : '\u25B6';
        }
    }

    function attemptAutoStart() {
        try {
            var AC = window.AudioContext || window.webkitAudioContext;
            var test = new AC();
            if (test.state === 'suspended') {
                test.close();
                // Chrome: show pulsing play button
                var btn = document.getElementById('music-toggle');
                if (btn) btn.style.animation = 'pulse 2s infinite';
                return;
            }
            test.close();
            startMusic();
        } catch (e) { /* no audio support */ }
    }

    function init() {
        var playBtn = document.getElementById('music-toggle');
        var volumeSlider = document.getElementById('music-volume');

        var saved = localStorage.getItem(STORAGE_KEY);
        var initVol = saved !== null ? parseFloat(saved) : 0.3;

        if (playBtn) playBtn.addEventListener('click', togglePlay);
        if (volumeSlider) {
            volumeSlider.value = Math.round(initVol * 100);
            volumeSlider.addEventListener('input', function (e) {
                var v = parseInt(e.target.value) / 100;
                localStorage.setItem(STORAGE_KEY, v.toString());
                if (masterGain && isPlaying) {
                    masterGain.gain.setTargetAtTime(v, audioCtx.currentTime, 0.1);
                }
            });
        }

        var audioEl = document.getElementById('ambient-audio');
        if (audioEl) { audioEl.removeAttribute('src'); audioEl.style.display = 'none'; }

        attemptAutoStart();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
