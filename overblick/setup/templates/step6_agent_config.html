{% extends "base.html" %}
{% block title %}Assign Agents{% endblock %}

{% block content %}
<h2 class="step-heading">Who Handles What?</h2>
<p class="step-description">
    Assign a personality to each use case. Each agent brings their unique voice and expertise.
</p>

<form method="post" action="/step/6">
    {% for uc in assignment_data %}
    <div class="assignment-section">
        <div class="assignment-header">
            <div class="assignment-header-icon" aria-hidden="true">{{ uc.icon }}</div>
            <div class="assignment-header-text">
                <div class="assignment-header-name">{{ uc.name }}</div>
                <div class="assignment-header-desc">{{ uc.description }}</div>
            </div>
        </div>

        {% if uc.compatible | length == 1 %}
        <!-- Single compatible personality — auto-assigned -->
        <input type="hidden" name="{{ uc.id }}_personality" value="{{ uc.compatible[0].name }}">
        <div class="auto-assigned">
            <span class="badge badge-green">Auto-assigned</span>
            <strong>{{ uc.compatible[0].display_name }}</strong>
            <span class="assignment-role">&mdash; {{ uc.compatible[0].role }}</span>
        </div>

        {% elif uc.compatible | length > 1 %}
        <!-- Multiple options — pick one -->
        <div class="personality-grid" role="radiogroup" aria-label="Choose personality for {{ uc.name }}">
            {% for char in uc.compatible %}
            <label class="personality-option" for="opt-{{ uc.id }}-{{ char.name }}">
                <input type="radio" id="opt-{{ uc.id }}-{{ char.name }}"
                       name="{{ uc.id }}_personality" value="{{ char.name }}"
                       {{ 'checked' if char.name == uc.assigned_personality }}>
                <div class="personality-option-inner">
                    <div class="personality-option-name">{{ char.display_name }}</div>
                    <div class="personality-option-role">{{ char.role }}</div>
                    {% if char.name == uc.recommended %}
                    <span class="badge badge-green">Recommended</span>
                    {% endif %}
                </div>
            </label>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Advanced settings (collapsed by default) -->
        <details class="assignment-config">
            <summary class="assignment-config-summary">Advanced settings</summary>
            <div class="assignment-config-body">
                <!-- Temperature -->
                <div class="form-group">
                    <label class="form-label">
                        Temperature:
                        <span class="form-range-value" id="{{ uc.id }}-temp-val">
                            {{ uc.temperature if uc.temperature is not none else state.llm.get('default_temperature', 0.7) }}
                        </span>
                    </label>
                    <input type="range" class="form-range"
                           name="{{ uc.id }}_temperature"
                           min="0" max="2" step="0.1"
                           value="{{ uc.temperature if uc.temperature is not none else state.llm.get('default_temperature', 0.7) }}"
                           oninput="document.getElementById('{{ uc.id }}-temp-val').textContent = this.value">
                </div>

                <!-- Max tokens -->
                <div class="form-group">
                    <label class="form-label" for="{{ uc.id }}_max_tokens">Max Tokens</label>
                    <input type="number" class="form-input"
                           name="{{ uc.id }}_max_tokens" id="{{ uc.id }}_max_tokens"
                           value="{{ uc.max_tokens if uc.max_tokens is not none else state.llm.get('default_max_tokens', 2000) }}"
                           min="100" max="32000">
                </div>

                <!-- Heartbeat -->
                <div class="form-group">
                    <label class="form-label" for="{{ uc.id }}_heartbeat_hours">
                        Heartbeat Interval (hours)
                    </label>
                    <span class="form-hint">How often the agent wakes up to check for work</span>
                    <input type="number" class="form-input"
                           name="{{ uc.id }}_heartbeat_hours" id="{{ uc.id }}_heartbeat_hours"
                           value="{{ uc.heartbeat_hours if uc.heartbeat_hours is not none else 4 }}"
                           min="1" max="24">
                </div>

                <!-- Quiet hours -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer;">
                        <input type="checkbox" name="{{ uc.id }}_quiet_hours" value="on"
                               {{ 'checked' if uc.quiet_hours }}>
                        <span class="form-label" style="margin-bottom: 0;">Enable quiet hours</span>
                    </label>
                    <span class="form-hint">Agent sleeps during nighttime</span>
                </div>
            </div>
        </details>
    </div>
    {% endfor %}

    <div class="btn-group btn-group-sticky">
        <a href="/step/5" class="btn btn-secondary">Back</a>
        <button type="submit" class="btn btn-primary">Next: Review</button>
    </div>
</form>
{% endblock %}
