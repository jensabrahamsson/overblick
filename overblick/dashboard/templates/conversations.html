{% extends "base.html" %}
{% block title %}Conversations{% endblock %}

{% block content %}
<div class="conversations-page">
    <h1 class="page-title">Agent Conversations</h1>
    <p class="page-subtitle">
        Inter-agent communication log. Read-only monitoring of IPC exchanges.
    </p>

    {% if not conversations %}
    <div class="conv-empty">
        <p>No agent conversations recorded yet.</p>
        <p class="conv-empty-hint">
            Conversations appear when agents communicate via IPC (e.g. health inquiries).
        </p>
    </div>
    {% else %}

    <!-- Filter -->
    <div class="conv-filter-bar">
        <select name="identity" class="form-select" aria-label="Filter by agent"
                data-action="filter-conversations">
            <option value="">All Agents</option>
            {% for ident in identities %}
            <option value="{{ ident }}" {% if selected_identity == ident %}selected{% endif %}>{{ ident }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Chat timeline -->
    <div class="conversation-timeline">
        {% for conv in conversations %}
        <div class="conv-entry">
            <!-- Header: timestamp + health grade -->
            <div class="conv-entry-header">
                <span class="conv-timestamp">
                    {{ conv.timestamp[:19].replace('T', ' ') }}
                    {% if conv.relative_time %}
                    <span class="conv-relative-time">({{ conv.relative_time }})</span>
                    {% endif %}
                </span>
                <span class="badge-type badge-type--{% if conv.conversation_type == 'email' %}email{% elif conv.conversation_type == 'research' %}research{% elif conv.health_grade == 'good' %}good{% elif conv.health_grade == 'fair' %}fair{% elif conv.health_grade == 'poor' %}poor{% else %}default{% endif %}">{% if conv.conversation_type == 'email' %}email{% elif conv.conversation_type == 'research' %}research{% elif conv.health_grade %}{{ conv.health_grade }}{% else %}{{ conv.source }}{% endif %}</span>
            </div>

            <!-- Inquiry (left-aligned) -->
            <div class="conv-bubble-row">
                <div class="conv-bubble">
                    <div class="conv-sender-label">
                        {{ conv.sender }}
                    </div>
                    <div class="conv-message-text">
                        {{ conv.motivation }}
                    </div>
                </div>
            </div>

            <!-- Response (right-aligned) -->
            <div class="conv-bubble-row--right">
                <div class="conv-bubble conv-bubble--response">
                    <div class="conv-sender-label conv-sender-label--right">
                        {{ conv.responder }}
                    </div>
                    <div class="conv-message-text">
                        {{ conv.response }}
                    </div>
                </div>
            </div>

            {% if conv.acknowledgment %}
            <!-- Acknowledgment from initiator (left-aligned) -->
            <div class="conv-bubble-row--ack">
                <div class="conv-bubble conv-bubble--ack">
                    <div class="conv-sender-label">
                        {{ conv.sender }} â€” ack
                    </div>
                    <div class="conv-ack-text">
                        {{ conv.acknowledgment }}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if conv.outcome %}
            <!-- Outcome footer -->
            <div class="conv-outcome">
                <span class="conv-outcome-label">Outcome:</span>
                <span class="conv-outcome-text">{{ conv.outcome }}</span>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}
