{% extends "base.html" %}

{% block title %}Stage{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Stage</h1>
    <p class="page-subtitle">Behavioral scenario testing — systematic identity verification</p>
</div>

{% if results %}
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
        <h2 style="margin: 0; font-size: 1rem;">Scenario Results</h2>
        <div>
            <span class="badge" style="background: var(--success, #38a169); color: white;">{{ results|selectattr('passed')|list|length }} passed</span>
            <span class="badge" style="background: var(--danger, #c53030); color: white;">{{ results|rejectattr('passed')|list|length }} failed</span>
        </div>
    </div>
    <div style="padding: 1rem; overflow-x: auto;">
        <table style="width: 100%; font-size: 0.85rem;">
            <thead><tr><th>Scenario</th><th>Identity</th><th>Status</th><th>Constraints</th><th>Pass Rate</th><th>Duration</th><th>Time</th></tr></thead>
            <tbody>
            {% for r in results %}
            <tr>
                <td><strong>{{ r.scenario_name }}</strong></td>
                <td>{{ r.identity }}</td>
                <td>
                    {% if r.passed %}
                    <span class="badge" style="background: var(--success, #38a169); color: white;">PASS</span>
                    {% else %}
                    <span class="badge" style="background: var(--danger, #c53030); color: white;">FAIL</span>
                    {% endif %}
                </td>
                <td>{{ r.passed_constraints }}/{{ r.total_constraints }}</td>
                <td>{{ "%.0f"|format(r.pass_rate * 100) }}%</td>
                <td>{{ "%.0f"|format(r.duration_ms) }}ms</td>
                <td>{{ r.run_at|epoch_to_datetime }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% for r in results %}
{% if not r.passed %}
<div class="card" style="margin-bottom: 1rem; border-left: 3px solid var(--danger, #c53030);">
    <div class="card-header">
        <h3 style="margin: 0; font-size: 0.95rem;">{{ r.scenario_name }} — {{ r.identity }}</h3>
        {% if r.error %}<span class="badge" style="background: var(--danger, #c53030); color: white;">Error: {{ r.error }}</span>{% endif %}
    </div>
    <div style="padding: 1rem;">
        {% for step in r.step_results %}
        {% if not step.passed %}
        <div style="margin-bottom: 0.75rem; padding: 0.5rem; background: var(--bg-secondary, #1a1a2e); border-radius: 4px; font-size: 0.85rem;">
            <strong>Step {{ step.step_index + 1 }}:</strong> {{ step.input_text }}
            {% for fc in step.failed_constraints %}
            <div style="color: var(--danger, #c53030); margin-top: 0.25rem; padding-left: 1rem;">
                {{ fc.constraint_type }}: {{ fc.message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}
{% endfor %}

{% else %}
<div class="card">
    <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
        <p>No scenario results yet.</p>
        <p style="font-size: 0.85rem;">Run scenarios via CLI: <code>python -m overblick stage run scenarios/</code></p>
    </div>
</div>
{% endif %}
{% endblock %}
