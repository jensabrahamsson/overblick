{% extends "base.html" %}

{% block title %}Stage{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Stage</h1>
    <p class="page-subtitle">Behavioral scenario testing — systematic identity verification</p>
</div>

{% if results %}
<div class="card stage-results-card">
    <div class="card-header">
        <h2 class="stage-card-title">Scenario Results</h2>
        <div>
            <span class="badge badge-pass">{{ results|selectattr('passed')|list|length }} passed</span>
            <span class="badge badge-fail">{{ results|rejectattr('passed')|list|length }} failed</span>
        </div>
    </div>
    <div class="stage-table-wrap">
        <table class="stage-table">
            <thead><tr><th>Scenario</th><th>Identity</th><th>Status</th><th>Constraints</th><th>Pass Rate</th><th>Duration</th><th>Time</th></tr></thead>
            <tbody>
            {% for r in results %}
            <tr>
                <td><strong>{{ r.scenario_name }}</strong></td>
                <td>{{ r.identity }}</td>
                <td>
                    {% if r.passed %}
                    <span class="badge badge-pass">PASS</span>
                    {% else %}
                    <span class="badge badge-fail">FAIL</span>
                    {% endif %}
                </td>
                <td>{{ r.passed_constraints }}/{{ r.total_constraints }}</td>
                <td>{{ "%.0f"|format(r.pass_rate * 100) }}%</td>
                <td>{{ "%.0f"|format(r.duration_ms) }}ms</td>
                <td>{{ r.run_at|epoch_to_datetime }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% for r in results %}
{% if not r.passed %}
<div class="card stage-failure-card">
    <div class="card-header">
        <h3 class="stage-failure-title">{{ r.scenario_name }} — {{ r.identity }}</h3>
        {% if r.error %}<span class="badge badge-fail">Error: {{ r.error }}</span>{% endif %}
    </div>
    <div class="stage-failure-body">
        {% for step in r.step_results %}
        {% if not step.passed %}
        <div class="stage-step-detail">
            <strong>Step {{ step.step_index + 1 }}:</strong> {{ step.input_text }}
            {% for fc in step.failed_constraints %}
            <div class="stage-constraint-error">
                {{ fc.constraint_type }}: {{ fc.message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}
{% endfor %}

{% else %}
<div class="card">
    <div class="stage-empty">
        <p>No scenario results yet.</p>
        <p class="stage-empty-hint">Run scenarios via CLI: <code>python -m overblick stage run scenarios/</code></p>
    </div>
</div>
{% endif %}
{% endblock %}
