<!-- Summary -->
<div class="health-bar" style="margin-bottom: var(--space-lg);">
    <div class="health-items">
        <div class="health-item">
            <span class="health-icon {% if total_calls > 0 %}health-ok{% else %}health-neutral{% endif %}" aria-hidden="true"></span>
            <span class="health-label">Total Calls</span>
            <span class="health-value">{{ total_calls }}</span>
        </div>
        <div class="health-item">
            <span class="health-icon health-neutral" aria-hidden="true"></span>
            <span class="health-label">Total Time</span>
            <span class="health-value">
                {% if total_duration >= 60000 %}{{ "%.1f"|format(total_duration / 60000) }}m
                {% elif total_duration >= 1000 %}{{ "%.1f"|format(total_duration / 1000) }}s
                {% else %}{{ total_duration|int }}ms{% endif %}
            </span>
        </div>
        <div class="health-item">
            <span class="health-icon health-neutral" aria-hidden="true"></span>
            <span class="health-label">Avg Duration</span>
            <span class="health-value">
                {% if avg_duration >= 1000 %}{{ "%.1f"|format(avg_duration / 1000) }}s
                {% else %}{{ avg_duration|int }}ms{% endif %}
            </span>
        </div>
    </div>
</div>

{% if entries %}
<table class="audit-table">
    <thead>
        <tr>
            <th scope="col">Time</th>
            <th scope="col">Identity</th>
            <th scope="col">Action</th>
            <th scope="col">Model</th>
            <th scope="col">Duration</th>
            <th scope="col">Response</th>
            <th scope="col">Status</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for entry in entries %}
        <tr class="audit-row {% if not entry.success %}audit-row-error{% endif %}">
            <td class="mono audit-time">{{ entry.timestamp|epoch_to_datetime }}</td>
            <td>{{ entry.identity }}</td>
            <td>{{ entry.action }}</td>
            <td class="mono text-muted llm-model-col">
                {% if entry.details is mapping and entry.details.model %}
                {{ entry.details.model }}
                {% else %}
                —
                {% endif %}
            </td>
            <td class="mono">
                {% if entry.duration_ms is not none %}
                    {% if entry.duration_ms >= 1000 %}{{ "%.1f"|format(entry.duration_ms / 1000) }}s{% else %}{{ entry.duration_ms|int }}ms{% endif %}
                {% else %}
                    —
                {% endif %}
            </td>
            <td class="mono">
                {% if entry.details is mapping and entry.details.content_length %}
                {{ entry.details.content_length }} chars
                {% else %}
                —
                {% endif %}
            </td>
            <td>
                {% if entry.success %}
                <span class="status-badge status-running">OK</span>
                {% else %}
                <span class="status-badge status-stopped">FAIL</span>
                {% if entry.error %}
                <div class="llm-error-reason">{{ entry.error[:120] }}{% if entry.error|length > 120 %}…{% endif %}</div>
                {% endif %}
                {% endif %}
            </td>
            <td>
                {% if entry.error or entry.details %}
                <button class="btn-expand" aria-label="Show details" aria-expanded="false">&#9660;</button>
                {% endif %}
            </td>
        </tr>
        {% if entry.error or entry.details %}
        <tr class="audit-detail-row" hidden>
            <td colspan="8">
                <div class="audit-detail">
                    {% if entry.error %}
                    <div class="audit-detail-error">
                        <strong>Error:</strong> {{ entry.error }}
                    </div>
                    {% endif %}
                    {% if entry.details %}
                    <div class="audit-detail-json">
                        <strong>Details:</strong>
                        <pre class="mono">{{ entry.details | tojson(indent=2) if entry.details is mapping else entry.details }}</pre>
                    </div>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table>

{% else %}
<div class="empty-state">
    <p>No LLM calls found.</p>
</div>
{% endif %}
