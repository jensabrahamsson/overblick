{% if conversation and conversation.turns %}
{% for turn in conversation.turns %}
{% set turn_type = turn.type | default("message") %}

{% if turn_type == "message" %}
{# Regular message: [HH:MM] <Nick> text #}
<div class="irc-line">
    <span class="irc-time">{{ turn.timestamp | irc_time }}</span>
    <span class="irc-nick" style="color: {{ color_map.get(turn.identity, 'var(--text-secondary)') }};">&lt;{{ turn.display_name or turn.identity }}&gt;</span>
    <span class="irc-text">{{ turn.content }}</span>
</div>

{% elif turn_type == "join" %}
{# Join: --> Nick has joined #channel #}
<div class="irc-line irc-event irc-event--join">
    <span class="irc-time">{{ turn.timestamp | irc_time }}</span>
    <span class="irc-event-marker">--&gt;</span>
    <span>{{ turn.display_name or turn.identity }} has joined {{ turn.content }}</span>
</div>

{% elif turn_type == "rejoin" %}
{# Rejoin: --> Nick has rejoined #channel #}
<div class="irc-line irc-event irc-event--rejoin">
    <span class="irc-time">{{ turn.timestamp | irc_time }}</span>
    <span class="irc-event-marker">--&gt;</span>
    <span>{{ turn.display_name or turn.identity }} has rejoined {{ turn.content }}</span>
</div>

{% elif turn_type == "part" %}
{# Part: <-- Nick has left #channel #}
<div class="irc-line irc-event irc-event--part">
    <span class="irc-time">{{ turn.timestamp | irc_time }}</span>
    <span class="irc-event-marker">&lt;--</span>
    <span>{{ turn.display_name or turn.identity }} has left {{ turn.content }}</span>
</div>

{% elif turn_type == "quit" %}
{# Quit: <-- Nick has quit (reason) #}
<div class="irc-line irc-event irc-event--quit">
    <span class="irc-time">{{ turn.timestamp | irc_time }}</span>
    <span class="irc-event-marker">&lt;--</span>
    <span>{{ turn.display_name or turn.identity }} has quit ({{ turn.content }})</span>
</div>

{% elif turn_type == "netsplit" %}
{# Netsplit: -!- Netsplit message #}
<div class="irc-line irc-event irc-event--netsplit">
    <span class="irc-time">{{ turn.timestamp | irc_time }}</span>
    <span class="irc-event-marker">-!-</span>
    <span>{{ turn.content }}</span>
</div>

{% elif turn_type == "topic" %}
{# Topic: -!- Topic for #channel: text #}
<div class="irc-line irc-event irc-event--topic">
    <span class="irc-time">{{ turn.timestamp | irc_time }}</span>
    <span class="irc-event-marker">-!-</span>
    <span>{{ turn.display_name or turn.identity }} changed the topic to: {{ turn.content }}</span>
</div>

{% else %}
{# Fallback: render as message (backward compatibility) #}
<div class="irc-line">
    <span class="irc-time">{{ turn.timestamp | irc_time }}</span>
    <span class="irc-nick" style="color: {{ color_map.get(turn.identity, 'var(--text-secondary)') }};">&lt;{{ turn.display_name or turn.identity }}&gt;</span>
    <span class="irc-text">{{ turn.content }}</span>
</div>
{% endif %}

{% endfor %}

{% if conversation.state == 'paused' %}
<div class="irc-status-banner irc-status-banner--paused">
    -!- Conversation paused â€” high system load
</div>
{% elif conversation.state == 'completed' %}
<div class="irc-status-banner irc-status-banner--completed">
    -!- Conversation completed ({{ conversation.turns | length }} turns)
</div>
{% elif conversation.state == 'cancelled' %}
<div class="irc-status-banner irc-status-banner--cancelled">
    -!- Conversation cancelled
</div>
{% endif %}

{% elif conversation %}
<div class="irc-status-banner irc-status-banner--completed">
    -!- Waiting for first message...
</div>
{% else %}
<div class="irc-status-banner irc-status-banner--completed">
    Select a conversation from the sidebar
</div>
{% endif %}
