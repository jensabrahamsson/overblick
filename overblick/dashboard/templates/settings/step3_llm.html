{% extends "settings/base.html" %}
{% block title %}AI Engine — Settings{% endblock %}

{% block content %}
<div class="detail">
    <div class="detail-header">
        <h1 class="detail-name">Step 3 — AI Engine</h1>
        <p class="detail-description">
            Configure your LLM backends. Enable one or more inference targets — the gateway
            routes requests based on priority and complexity.
        </p>
    </div>

    {% if error %}
    <div class="flash flash-error" role="alert">{{ error }}</div>
    {% endif %}

    <div class="card" style="max-width: 720px;">
        <form method="post" action="/settings/step/3" hx-boost="true">
            {% set llm = state.llm or {} %}
            {% set local = llm.get('local', {}) %}
            {% set cloud = llm.get('cloud', {}) %}
            {% set deepseek = llm.get('deepseek', {}) %}
            {% set openai = llm.get('openai', {}) %}

            <!-- Gateway (always visible — infrastructure) -->
            <div class="form-group">
                <p class="form-hint" style="margin-bottom: var(--space-sm);">── Gateway ─────────────────────────────────────</p>
                <div style="display: flex; align-items: center; gap: var(--space-md);">
                    <div style="flex: 1;">
                        <label class="form-label" for="gateway_url">Gateway URL</label>
                        <input type="text" class="form-input" id="gateway_url" name="gateway_url"
                               value="{{ llm.get('gateway_url', 'http://127.0.0.1:8200') }}">
                    </div>
                    <div style="padding-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary btn-sm"
                                hx-post="/settings/test/gateway"
                                hx-include="#gateway_url"
                                hx-target="#gateway-status">
                            Test
                        </button>
                        <span id="gateway-status" class="test-result"></span>
                    </div>
                </div>
            </div>

            <!-- Backends -->
            <p class="form-hint" style="margin: var(--space-lg) 0 var(--space-sm);">── Backends ─────────────────────────────────────</p>

            <!-- Local Inference -->
            <div class="form-group" style="padding: var(--space-md); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: var(--space-md);">
                <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer;">
                    <input type="checkbox" name="local_enabled" value="on"
                           {{ 'checked' if local.get('enabled', true) else '' }}
                           onchange="toggleSection('local-config', this.checked)">
                    <strong>Local Inference</strong>
                    <span class="form-hint" style="margin: 0;">(Ollama / LM Studio)</span>
                </label>

                <div id="local-config" style="display: {{ 'block' if local.get('enabled', true) else 'none' }}; margin-top: var(--space-md);">
                    <div style="display: grid; grid-template-columns: 1fr 2fr 1fr 2fr; gap: var(--space-sm); align-items: end;">
                        <div>
                            <label class="form-label">Type</label>
                            <select class="form-select" name="local_type" id="local_type"
                                    onchange="updateLocalPort(this.value)">
                                <option value="ollama" {{ 'selected' if local.get('backend_type', 'ollama') == 'ollama' else '' }}>Ollama</option>
                                <option value="lmstudio" {{ 'selected' if local.get('backend_type') == 'lmstudio' else '' }}>LM Studio</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Host</label>
                            <input type="text" class="form-input" name="local_host" id="local_host"
                                   value="{{ local.get('host', '127.0.0.1') }}">
                        </div>
                        <div>
                            <label class="form-label">Port</label>
                            <input type="number" class="form-input" name="local_port" id="local_port"
                                   value="{{ local.get('port', 11434) }}">
                        </div>
                        <div>
                            <label class="form-label">Model</label>
                            <input type="text" class="form-input" name="local_model"
                                   value="{{ local.get('model', 'qwen3:8b') }}" list="local-model-suggestions">
                            <datalist id="local-model-suggestions">
                                <option value="qwen3:8b">
                                <option value="qwen3:14b">
                                <option value="llama3:8b">
                                <option value="mistral:7b">
                                <option value="gemma2:9b">
                            </datalist>
                        </div>
                    </div>
                    <div style="margin-top: var(--space-sm);">
                        <button type="button" class="btn btn-secondary btn-sm"
                                hx-post="/settings/test/ollama"
                                hx-include="#local_host, #local_port"
                                hx-target="#local-status">
                            Test Connection
                        </button>
                        <span id="local-status" class="test-result"></span>
                    </div>
                </div>
            </div>

            <!-- Cloud Remote -->
            <div class="form-group" style="padding: var(--space-md); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: var(--space-md);">
                <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer;">
                    <input type="checkbox" name="cloud_enabled" value="on"
                           {{ 'checked' if cloud.get('enabled', false) else '' }}
                           onchange="toggleSection('cloud-config', this.checked)">
                    <strong>Cloud Remote</strong>
                    <span class="form-hint" style="margin: 0;">(Ollama / LM Studio on remote server)</span>
                </label>

                <div id="cloud-config" style="display: {{ 'block' if cloud.get('enabled', false) else 'none' }}; margin-top: var(--space-md);">
                    <div style="display: grid; grid-template-columns: 1fr 2fr 1fr 2fr; gap: var(--space-sm); align-items: end;">
                        <div>
                            <label class="form-label">Type</label>
                            <select class="form-select" name="cloud_type">
                                <option value="ollama" {{ 'selected' if cloud.get('backend_type', 'ollama') == 'ollama' else '' }}>Ollama</option>
                                <option value="lmstudio" {{ 'selected' if cloud.get('backend_type') == 'lmstudio' else '' }}>LM Studio</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Host</label>
                            <input type="text" class="form-input" name="cloud_host" id="cloud_host"
                                   value="{{ cloud.get('host', '') }}" placeholder="gpu.example.com">
                        </div>
                        <div>
                            <label class="form-label">Port</label>
                            <input type="number" class="form-input" name="cloud_port" id="cloud_port"
                                   value="{{ cloud.get('port', 11434) }}">
                        </div>
                        <div>
                            <label class="form-label">Model</label>
                            <input type="text" class="form-input" name="cloud_model"
                                   value="{{ cloud.get('model', 'qwen3:8b') }}">
                        </div>
                    </div>
                    <div style="margin-top: var(--space-sm);">
                        <button type="button" class="btn btn-secondary btn-sm"
                                hx-post="/settings/test/ollama"
                                hx-include="#cloud_host, #cloud_port"
                                hx-target="#cloud-status">
                            Test Connection
                        </button>
                        <span id="cloud-status" class="test-result"></span>
                    </div>
                </div>
            </div>

            <!-- Deepseek -->
            <div class="form-group" style="padding: var(--space-md); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: var(--space-md);">
                <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer;">
                    <input type="checkbox" name="deepseek_enabled" value="on"
                           {{ 'checked' if deepseek.get('enabled', false) else '' }}
                           onchange="toggleSection('deepseek-config', this.checked)">
                    <strong>Deepseek</strong>
                    <span class="form-hint" style="margin: 0;">(Cloud API — deepseek-chat)</span>
                </label>

                <div id="deepseek-config" style="display: {{ 'block' if deepseek.get('enabled', false) else 'none' }}; margin-top: var(--space-md);">
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-sm); align-items: end;">
                        <div>
                            <label class="form-label">API Key</label>
                            <input type="password" class="form-input" name="deepseek_api_key" id="deepseek_api_key"
                                   placeholder="{{ '••••••••' if state.get('_has_deepseek_api_key') else 'sk-...' }}"
                                   autocomplete="off">
                        </div>
                        <div>
                            <label class="form-label">Model</label>
                            <input type="text" class="form-input" name="deepseek_model"
                                   value="{{ deepseek.get('model', 'deepseek-chat') }}">
                        </div>
                    </div>
                    <div style="margin-top: var(--space-sm);">
                        <button type="button" class="btn btn-secondary btn-sm"
                                hx-post="/settings/test/deepseek"
                                hx-include="#deepseek_api_key"
                                hx-target="#deepseek-status">
                            Test Connection
                        </button>
                        <span id="deepseek-status" class="test-result"></span>
                    </div>
                </div>
            </div>

            <!-- OpenAI (Coming soon) -->
            <div class="form-group" style="padding: var(--space-md); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: var(--space-md); opacity: 0.5;">
                <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: not-allowed;">
                    <input type="checkbox" disabled>
                    <strong>OpenAI</strong>
                    <span class="badge badge-amber" style="font-size: 0.7rem;">Coming soon</span>
                </label>
                <input type="hidden" name="openai_api_url" value="{{ openai.get('api_url', 'https://api.openai.com/v1') }}">
                <input type="hidden" name="openai_model" value="{{ openai.get('model', 'gpt-4o') }}">
            </div>

            <!-- Common Settings -->
            <p class="form-hint" style="margin: var(--space-lg) 0 var(--space-sm);">── Common Settings ──────────────────────────────</p>

            <div class="form-group">
                <label class="form-label" for="default_backend">Default Backend</label>
                <select class="form-select" name="default_backend" id="default_backend">
                    <option value="local" {{ 'selected' if llm.get('default_backend', 'local') == 'local' else '' }}>Local</option>
                    <option value="cloud" {{ 'selected' if llm.get('default_backend') == 'cloud' else '' }}>Cloud Remote</option>
                    <option value="deepseek" {{ 'selected' if llm.get('default_backend') == 'deepseek' else '' }}>Deepseek</option>
                </select>
                <span class="form-hint">Used when no routing rule applies. Complexity-based routing may override this.</span>
            </div>

            <div class="form-group">
                <label class="form-label">
                    Temperature: <span id="temp-value">{{ llm.get('default_temperature', 0.7) }}</span>
                </label>
                <span class="form-hint" id="temp_hint">Lower = more focused, Higher = more creative (0.0–2.0)</span>
                <input type="range" class="form-range" id="default_temperature" name="default_temperature"
                       min="0" max="2" step="0.1" value="{{ llm.get('default_temperature', 0.7) }}"
                       oninput="document.getElementById('temp-value').textContent = this.value"
                       aria-describedby="temp_hint">
            </div>

            <div class="form-group">
                <label class="form-label" for="default_max_tokens">Max tokens</label>
                <span class="form-hint" id="max_tokens_hint">Maximum response length (100–32000)</span>
                <input type="number" class="form-input" id="default_max_tokens" name="default_max_tokens"
                       value="{{ llm.get('default_max_tokens', 2000) }}" min="100" max="32000"
                       aria-describedby="max_tokens_hint">
            </div>

            <div class="btn-group">
                <a href="/settings/step/2" class="btn btn-ghost">Back</a>
                <button type="submit" class="btn btn-primary">Next: Communication</button>
            </div>
        </form>
    </div>
</div>

<script>
function toggleSection(sectionId, show) {
    document.getElementById(sectionId).style.display = show ? 'block' : 'none';
}

function updateLocalPort(type) {
    var portInput = document.getElementById('local_port');
    if (!portInput) return;
    if (type === 'lmstudio' && portInput.value === '11434') {
        portInput.value = '1234';
    } else if (type === 'ollama' && portInput.value === '1234') {
        portInput.value = '11434';
    }
}
</script>
{% endblock %}
