{% extends "settings/base.html" %}
{% block title %}Review — Settings{% endblock %}

{% block content %}
<div class="detail">
    <div class="detail-header">
        <h1 class="detail-name">Step 8 — Review</h1>
        <p class="detail-description">
            Review everything before saving. Click "Save Settings" to write your configuration.
        </p>
    </div>


    <div class="card settings-card-wide">
        {% set principal = state.principal or {} %}
        {% set llm = state.llm or {} %}
        {% set comm = state.communication or {} %}

        <!-- Principal -->
        <div class="review-section">
            <div class="review-section-title">
                Principal Identity
                <a href="/settings/step/2" class="review-edit">edit</a>
            </div>
            <div class="review-item">
                <span class="review-label">Name</span>
                <span class="review-value">{{ principal.get('principal_name', 'Not set') }}</span>
            </div>
            {% if principal.get('principal_email') %}
            <div class="review-item">
                <span class="review-label">Email</span>
                <span class="review-value">{{ principal.get('principal_email') }}</span>
            </div>
            {% endif %}
            <div class="review-item">
                <span class="review-label">Timezone</span>
                <span class="review-value">{{ principal.get('timezone', 'Europe/Stockholm') }}</span>
            </div>
        </div>

        <!-- LLM -->
        {% set local = llm.get('local', {}) %}
        {% set cloud_cfg = llm.get('cloud', {}) %}
        {% set deepseek = llm.get('deepseek', {}) %}
        <div class="review-section">
            <div class="review-section-title">
                AI Engine
                <a href="/settings/step/3" class="review-edit">edit</a>
            </div>
            <div class="review-item">
                <span class="review-label">Gateway</span>
                <span class="review-value mono">{{ llm.get('gateway_url', 'http://127.0.0.1:8200') }}</span>
            </div>
            <div class="review-item">
                <span class="review-label">Backends</span>
                <span class="review-value">
                    {% if local.get('enabled') %}
                    <span class="badge badge-green">Local</span>
                    <span class="mono" class="review-model-name">{{ local.get('model', 'qwen3:8b') }}</span>
                    {% endif %}
                    {% if cloud_cfg.get('enabled') %}
                    <span class="badge badge-green" class="review-badge-ml">Cloud</span>
                    <span class="mono" class="review-model-name">{{ cloud_cfg.get('model', 'qwen3:8b') }}</span>
                    {% endif %}
                    {% if deepseek.get('enabled') %}
                    <span class="badge badge-green" class="review-badge-ml">Deepseek</span>
                    <span class="mono" class="review-model-name">{{ deepseek.get('model', 'deepseek-chat') }}</span>
                    {% endif %}
                    {% if not local.get('enabled') and not cloud_cfg.get('enabled') and not deepseek.get('enabled') %}
                    <span class="badge badge-amber">None enabled</span>
                    {% endif %}
                </span>
            </div>
            <div class="review-item">
                <span class="review-label">Default</span>
                <span class="review-value">{{ llm.get('default_backend', 'local') | title }}</span>
            </div>
            <div class="review-item">
                <span class="review-label">Temperature</span>
                <span class="review-value">{{ llm.get('default_temperature', 0.7) }}</span>
            </div>
        </div>

        <!-- Communication -->
        <div class="review-section">
            <div class="review-section-title">
                Communication
                <a href="/settings/step/4" class="review-edit">edit</a>
            </div>
            <div class="review-item">
                <span class="review-label">Gmail</span>
                <span class="review-value">
                    {% if comm.get('gmail_enabled') %}
                    <span class="badge badge-green">Enabled</span> {{ comm.get('gmail_address', '') }}
                    {% else %}
                    <span class="badge badge-muted">Disabled</span>
                    {% endif %}
                </span>
            </div>
            <div class="review-item">
                <span class="review-label">Telegram</span>
                <span class="review-value">
                    {% if comm.get('telegram_enabled') %}
                    <span class="badge badge-green">Enabled</span>
                    {% else %}
                    <span class="badge badge-muted">Disabled</span>
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- Agent Assignments -->
        <div class="review-section">
            <div class="review-section-title">
                Agent Assignments
                <a href="/settings/step/6" class="review-edit">edit</a>
            </div>
            {% for a in review_assignments %}
            <div class="review-item">
                <span class="review-label">
                    <span aria-hidden="true">{{ a.use_case_icon }}</span> {{ a.use_case }}
                </span>
                <span class="review-value">
                    <strong>{{ a.personality_display }}</strong>
                    {% for plugin in a.plugins %}
                    <span class="badge badge-purple" class="review-badge-ml">{{ plugin_name(plugin) }}</span>
                    {% endfor %}
                </span>
            </div>
            {% endfor %}
        </div>

        <!-- What will be written -->
        <div class="review-section">
            <div class="review-section-title">Files to write</div>
            <div class="review-item">
                <span class="review-label">Config</span>
                <span class="review-value mono" class="review-model-name">config/overblick.yaml</span>
            </div>
            <div class="review-item">
                <span class="review-label">Secrets</span>
                <span class="review-value mono" class="review-model-name">
                    {% for name in state.selected_characters %}config/secrets/{{ name }}.yaml{% if not loop.last %}, {% endif %}{% endfor %}
                </span>
            </div>
        </div>

        <form method="post" action="/settings/step/8" id="provision-form" hx-boost="true">
            <div class="btn-group mt-3">
                <a href="/settings/step/7" class="btn btn-ghost">Back</a>
                <button type="submit" class="btn btn-primary btn-large" id="provision-btn">
                    {% if pre_populated %}Save Settings{% else %}Create Everything{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
