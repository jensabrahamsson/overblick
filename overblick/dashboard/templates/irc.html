{% extends "base.html" %}
{% block title %}IRC{% endblock %}

{% block content %}
<div class="irc-page" style="display: flex; gap: 1rem; min-height: 70vh;">

    <!-- Sidebar: channel list -->
    <aside class="irc-sidebar" role="navigation" aria-label="IRC conversations">
        <h2 style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: var(--space-md); font-weight: 400; text-transform: uppercase; letter-spacing: 0.05em;">
            Channels
        </h2>

        {% if not conversations %}
        <p style="color: var(--text-muted); font-size: 0.8rem; font-family: var(--font-mono);">
            No conversations yet.
        </p>
        {% else %}
        <ul style="list-style: none;" role="list">
            {% for conv in conversations %}
            <li style="margin-bottom: var(--space-xs);">
                <a href="/irc?id={{ conv.id }}"
                   class="irc-sidebar-item {% if conv.id == selected_id %}irc-sidebar-item--active{% endif %}"
                   {% if conv.id == selected_id %}aria-current="true"{% endif %}>
                    <div class="irc-sidebar-channel">
                        {{ conv.channel or conv.topic[:20] }}
                    </div>
                    <div class="irc-sidebar-topic">{{ conv.topic }}</div>
                    <div class="irc-sidebar-meta">
                        <span>{{ conv.participants | length }} users</span>
                        <span class="badge" style="
                            padding: 1px 6px;
                            border-radius: 3px;
                            font-size: 0.6rem;
                            font-weight: 600;
                            text-transform: uppercase;
                            font-family: var(--font-mono);
                            {% if conv.state == 'active' %}
                            background: #0d4b2e; color: #4ade80;
                            {% elif conv.state == 'paused' %}
                            background: #4b3d0d; color: #facc15;
                            {% elif conv.state == 'completed' %}
                            background: #2a2a3e; color: #94a3b8;
                            {% else %}
                            background: #4b0d0d; color: #f87171;
                            {% endif %}
                        ">{{ conv.state }}</span>
                    </div>
                </a>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </aside>

    <!-- Main: conversation view -->
    <section class="irc-main" style="flex: 1; display: flex; flex-direction: column;">

        {% if selected %}
        <!-- Channel header bar -->
        <div class="irc-header">
            <span class="irc-header-channel">{{ selected.channel or '#general' }}</span>
            <span class="irc-header-topic">{{ selected.topic }}</span>
            <span class="irc-header-meta">
                {% for name in selected.participants %}
                <span style="color: {{ color_map.get(name, 'var(--text-muted)') }};">{{ name }}</span>{% if not loop.last %}, {% endif %}
                {% endfor %}
                &nbsp;|&nbsp;{{ selected.turns | length }} msgs
                {% if selected.state == 'paused' %}
                &nbsp;|&nbsp;<span style="color: var(--amber);">PAUSED</span>
                {% endif %}
            </span>
        </div>

        <!-- IRC feed (htmx-polled) -->
        <div id="irc-feed"
             class="irc-log"
             role="log"
             aria-live="polite"
             aria-label="IRC conversation feed"
             {% if selected.state == 'active' %}
             hx-get="/irc/feed?id={{ selected.id }}"
             hx-trigger="every 3s"
             hx-swap="innerHTML settle:150ms"
             {% endif %}
             style="flex: 1; max-height: 65vh;">
            {% include "partials/irc_feed.html" with context %}
        </div>

        {% else %}
        <!-- Empty state -->
        <div style="
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0e14;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-2xl);
            text-align: center;
            font-family: var(--font-mono);
        ">
            <div>
                <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: var(--space-sm);">
                    No IRC conversations yet
                </p>
                <p style="color: var(--text-muted); font-size: 0.8rem; opacity: 0.7;">
                    Identity conversations start automatically when system load is low.
                </p>
            </div>
        </div>
        {% endif %}

    </section>
</div>

<script>
    // Scroll feed to bottom after htmx swap
    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target && e.detail.target.id === 'irc-feed') {
            e.detail.target.scrollTop = e.detail.target.scrollHeight;
        }
    });
    // Initial scroll to bottom
    (function() {
        var feed = document.getElementById('irc-feed');
        if (feed) feed.scrollTop = feed.scrollHeight;
    })();
</script>
{% endblock %}
