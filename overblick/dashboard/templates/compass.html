{% extends "base.html" %}

{% block title %}Compass{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Compass</h1>
    <p class="page-subtitle">Identity drift detection — monitoring personality integrity over time</p>
</div>

{# ── A. Status Strip ── #}
<div class="compass-status-strip">
    <h2 class="card-title">Identity Overview</h2>
    <div class="identity-dot-row" role="group" aria-label="Identity drift status indicators">
        {% if baselines %}
            {% for name, bl in baselines.items() %}
            {% set status = identity_status.get(name, {}) %}
            {% set sev = status.get('severity', 'low') %}
            <span class="status-dot {% if sev == 'high' or sev == 'critical' %}status-error{% elif sev == 'medium' or sev == 'warning' %}status-starting{% else %}status-running{% endif %}"
                  title="{{ name }}: {{ '%.2f'|format(status.get('drift_score', 0)) }} drift"
                  aria-label="{{ name }} — {{ sev }} drift level"></span>
            {% endfor %}
        {% else %}
            <span class="text-muted">No baselines established</span>
        {% endif %}
    </div>
</div>

{# ── B. Two-Column Layout ── #}
<div class="compass-grid">
    {# ── Left: Baseline Cards ── #}
    <section>
        <h2 class="section-title">Active Baselines</h2>
        {% if baselines %}
        <div class="detail-grid">
            {% for name, bl in baselines.items() %}
            {% set status = identity_status.get(name, {}) %}
            {% set score = status.get('drift_score', 0) %}
            {% set sev = status.get('severity', 'low') %}
            {% set gauge_sev = 'low' if sev in ('low', 'info') else ('medium' if sev == 'warning' else 'high') %}
            {% set pct = [((score / (drift_threshold * 3)) * 100)|int, 100]|min %}
            <div class="card">
                <h3 class="agent-card-name">{{ name }}</h3>
                <div class="trait-bar">
                    <span class="trait-name">Drift</span>
                    <div class="drift-gauge" role="meter"
                         aria-label="Drift level for {{ name }}"
                         aria-valuenow="{{ '%.2f'|format(score) }}"
                         aria-valuemin="0"
                         aria-valuemax="{{ '%.1f'|format(drift_threshold * 3) }}">
                        <div class="drift-gauge-fill" data-severity="{{ gauge_sev }}"
                             style="width: {{ pct }}%;"></div>
                    </div>
                    <span class="trait-value">{{ '%.2f'|format(score) }}</span>
                </div>
                <div class="agent-card-meta">
                    <span class="badge-state {% if gauge_sev == 'low' %}badge-state--active{% elif gauge_sev == 'medium' %}badge-state--paused{% else %}badge-state--error{% endif %}">
                        {{ gauge_sev|upper }}
                    </span>
                    <span>{{ bl.sample_count }} samples</span>
                    <span>{{ bl.established_at|epoch_to_datetime }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card empty-state">
            <p>No baselines established yet.</p>
            <p class="text-muted">Baselines are created automatically as identities generate content.</p>
        </div>
        {% endif %}
    </section>

    {# ── Right: Alert Stack ── #}
    <section>
        <h2 class="section-title">Drift Alerts</h2>
        {% if alerts %}
        <div class="alert-stack" role="log" aria-label="Identity drift alerts">
            {% for alert in alerts[:10] %}
            <div class="alert-item alert-item--{{ alert.severity }}" role="status">
                <div class="detail-title-row">
                    <strong>{{ alert.identity_name }}</strong>
                    <span class="badge-state {% if alert.severity == 'critical' %}badge-state--error{% elif alert.severity == 'warning' %}badge-state--paused{% else %}badge-state--active{% endif %}">
                        {{ alert.severity|upper }}
                    </span>
                </div>
                <p class="text-muted">
                    Drift {{ '%.2f'|format(alert.drift_score) }} (threshold: {{ alert.threshold }})
                </p>
                {% if alert.drifted_dimensions %}
                <div class="tag-list">
                    {% for dim in alert.drifted_dimensions %}
                    <span class="tag tag-sm">{{ dim }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card empty-state">
            <span class="health-icon health-ok" aria-hidden="true"></span>
            <p>All identities within drift tolerance</p>
            <p class="text-muted">No alerts to report — all personality baselines are stable.</p>
        </div>
        {% endif %}
    </section>
</div>

{# ── C. Drift History ── #}
{% if drift_history %}
<section>
    <div class="section-header">
        <h2 class="section-title">Drift History</h2>
        <div class="view-toggle" role="group" aria-label="History view toggle">
            <button class="btn" aria-pressed="true" onclick="toggleDriftView('timeline', this)">Timeline</button>
            <button class="btn" aria-pressed="false" onclick="toggleDriftView('table', this)">Table</button>
        </div>
    </div>

    {# Timeline view (default) #}
    <div id="drift-timeline-view" class="card">
        <div class="drift-timeline">
            {% for dm in drift_history[:20] %}
            {% set sev = dm.severity|default('info') %}
            {% set dot_sev = 'low' if sev == 'info' else ('medium' if sev == 'warning' else 'high') %}
            <div class="drift-timeline-entry">
                <div class="drift-timeline-dot" data-severity="{{ dot_sev }}" tabindex="0"
                     role="listitem" aria-label="{{ dm.identity_name }}: drift {{ '%.2f'|format(dm.drift_score) }}"></div>
                <div>
                    <strong>{{ dm.identity_name }}</strong>
                    <span class="badge-state {% if sev == 'critical' %}badge-state--error{% elif sev == 'warning' %}badge-state--paused{% else %}badge-state--active{% endif %}">
                        {{ '%.2f'|format(dm.drift_score) }}
                    </span>
                    {% if dm.drifted_dimensions %}
                    <span class="text-muted"> — {{ dm.drifted_dimensions|join(', ') }}</span>
                    {% endif %}
                    <div class="text-muted audit-time">{{ dm.measured_at|epoch_to_datetime }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    {# Table view (hidden by default) #}
    <div id="drift-table-view" class="card" hidden>
        <table class="audit-table">
            <thead>
                <tr>
                    <th>Identity</th>
                    <th>Drift Score</th>
                    <th>Severity</th>
                    <th>Drifted Dimensions</th>
                    <th>Samples</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                {% for dm in drift_history[:30] %}
                {% set sev = dm.severity|default('info') %}
                <tr>
                    <td><strong>{{ dm.identity_name }}</strong></td>
                    <td>{{ '%.2f'|format(dm.drift_score) }}</td>
                    <td>
                        <span class="badge-state {% if sev == 'critical' %}badge-state--error{% elif sev == 'warning' %}badge-state--paused{% else %}badge-state--active{% endif %}">
                            {{ sev|upper }}
                        </span>
                    </td>
                    <td>{{ dm.drifted_dimensions|join(', ') or '—' }}</td>
                    <td>{{ dm.sample_count }}</td>
                    <td class="audit-time">{{ dm.measured_at|epoch_to_datetime }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<script>
function toggleDriftView(view, btn) {
    var timeline = document.getElementById('drift-timeline-view');
    var table = document.getElementById('drift-table-view');
    var buttons = btn.parentElement.querySelectorAll('.btn');
    buttons.forEach(function(b) { b.setAttribute('aria-pressed', 'false'); });
    btn.setAttribute('aria-pressed', 'true');
    if (view === 'timeline') {
        timeline.hidden = false;
        table.hidden = true;
    } else {
        timeline.hidden = true;
        table.hidden = false;
    }
}
</script>
{% endblock %}
