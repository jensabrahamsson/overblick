{% extends "base.html" %}
{% block title %}{{ identity.display_name }}{% endblock %}

{% block content %}
<div class="detail">
    <div class="detail-header">
        <div class="detail-title-row">
            <h1 class="detail-name">{{ identity.display_name }}</h1>
            <span class="status-badge status-{{ agent_status.get('state', 'offline') }}">
                {{ agent_status.get('state', 'offline') }}
            </span>
            {% if supervisor_running is defined and supervisor_running %}
            <div class="detail-actions">
                {% if can_start %}
                <button class="btn btn-agent-start btn-sm"
                        hx-post="/agent/{{ identity.name }}/start"
                        hx-swap="none"
                        hx-on::after-request="location.reload()"
                        aria-label="Start {{ identity.display_name }}">Start</button>
                {% endif %}
                {% if can_stop %}
                <button class="btn btn-agent-stop btn-sm"
                        hx-post="/agent/{{ identity.name }}/stop"
                        hx-swap="none"
                        hx-on::after-request="location.reload()"
                        hx-confirm="Stop agent {{ identity.display_name }}?"
                        aria-label="Stop {{ identity.display_name }}">Stop</button>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <p class="detail-description">{{ identity.description }}</p>
    </div>

    <div class="detail-grid">
        <!-- Identity Info -->
        <div class="card">
            <h3 class="card-title">Identity</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Name</span>
                    <span class="info-value">{{ identity.name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Version</span>
                    <span class="info-value">{{ identity.version }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Identity</span>
                    <span class="info-value">{{ identity.identity_ref or 'default' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">LLM Model</span>
                    <span class="info-value mono">{{ identity.llm.model }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Temperature</span>
                    <span class="info-value">{{ identity.llm.temperature }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Max Tokens</span>
                    <span class="info-value">{{ identity.llm.max_tokens }}</span>
                </div>
            </div>
        </div>

        <!-- Runtime Status -->
        <div class="card">
            <h3 class="card-title">Runtime</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">State</span>
                    <span class="info-value">
                        <span class="status-dot status-{{ agent_status.get('state', 'offline') }}" aria-hidden="true"></span>
                        {{ agent_status.get('state', 'offline') }}
                    </span>
                </div>
                {% if agent_status.get('pid') %}
                <div class="info-item">
                    <span class="info-label">PID</span>
                    <span class="info-value mono">{{ agent_status.pid }}</span>
                </div>
                {% endif %}
                <div class="info-item">
                    <span class="info-label">Uptime</span>
                    <span class="info-value">{{ _format_uptime(agent_status.get('uptime', 0)) }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Restarts</span>
                    <span class="info-value">{{ agent_status.get('restart_count', 0) }}</span>
                </div>
            </div>
        </div>

        <!-- Plugins & Capabilities -->
        <div class="card">
            <h3 class="card-title">Active Plugins</h3>
            <div class="tag-list">
                {% for p in identity.plugins %}
                <span class="tag tag-plugin">{{ p }}</span>
                {% endfor %}
                {% if not identity.plugins %}
                <span class="text-muted">No plugins configured</span>
                {% endif %}
            </div>

            <h3 class="card-title mt-3">Capabilities</h3>
            <div class="tag-list">
                {% for cap in identity.capability_names %}
                {% if cap not in ['dream_system', 'therapy_system', 'emotional_state'] %}
                <span class="tag {{ 'tag-operational' if _is_operational_cap(cap) else 'tag-capability' }}">{{ cap }}</span>
                {% endif %}
                {% endfor %}
                {% if not identity.capability_names %}
                <span class="text-muted">No capabilities configured</span>
                {% endif %}
            </div>
            {% if 'dream_system' in identity.capability_names or
                 'therapy_system' in identity.capability_names or
                 'emotional_state' in identity.capability_names %}
            <p class="text-muted mt-2" style="font-size: 0.85em;">
                <em>Note: Psychology capabilities are now configured via Psychological Framework (see below).</em>
            </p>
            {% endif %}
        </div>

        <!-- Personality Traits -->
        {% if personality and personality.traits %}
        <div class="card">
            <h3 class="card-title">Personality Traits</h3>
            <div class="trait-bars">
                {% for trait_name, trait_value in personality.traits.items() %}
                <div class="trait-bar">
                    <span class="trait-name">{{ trait_name }}</span>
                    <div class="trait-track">
                        <div class="trait-fill" style="width: {{ (trait_value * 100)|int }}%"></div>
                    </div>
                    <span class="trait-value">{{ "%.1f"|format(trait_value) }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Psychological Framework -->
        {% if personality and personality.raw.get('psychological_framework') %}
        <div class="card">
            <h3 class="card-title">Psychological Framework</h3>
            {% set psych = personality.raw.get('psychological_framework') %}

            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Primary Framework</span>
                    <span class="info-value">{{ psych.get('primary', 'None').replace('_', ' ').title() }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Self-Reflection Style</span>
                    <span class="info-value">{{ psych.get('self_reflection_style', 'N/A').replace('_', ' ') }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Dream Interpretation</span>
                    <span class="info-value">{{ 'Yes' if psych.get('dream_interpretation') else 'No' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Therapeutic Approach</span>
                    <span class="info-value">{{ psych.get('therapeutic_approach', 'N/A').replace('_', ' ') }}</span>
                </div>
            </div>

            {% if psych.get('domains') %}
            <h4 class="mt-2" style="font-size: 0.9rem; color: var(--text-secondary);">Domains</h4>
            <div class="tag-list">
                {% for domain in psych.get('domains', []) %}
                <span class="tag tag-psychology">{{ domain.replace('_', ' ') }}</span>
                {% endfor %}
            </div>
            {% endif %}

            {% if psych.get('key_concepts') %}
            <h4 class="mt-2" style="font-size: 0.9rem; color: var(--text-secondary);">Key Concepts</h4>
            <ul style="margin-top: 0.5rem; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                {% for concept in psych.get('key_concepts', []) %}
                <li>{{ concept }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Audit Trail -->
    <section class="section mt-4">
        <h2 class="section-title">Recent Activity</h2>
        {% with entries=audit_entries %}
        {% include "partials/audit_table.html" %}
        {% endwith %}
    </section>

    <a href="/" class="btn btn-ghost mt-3">Back to Dashboard</a>
</div>
{% endblock %}
